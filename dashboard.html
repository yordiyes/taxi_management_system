<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Taxi Service</title>
    <link rel="stylesheet" href="css/modern.css">
</head>

<body>
    <header>
        <nav>
            <a href="index.html" class="logo">Global Tourism Hub</a>
            <ul class="nav-links" id="nav-list">
                <!-- Nav items injected by JS -->
            </ul>
        </nav>
    </header>

    <main class="container">
        <div style="padding: 2rem 0;">
            <h1 style="margin-bottom: 2rem;">Service Management</h1>
            <div id="dashboard-content">
                <!-- Content loaded via JS -->
                <p class="text-muted">Initializing dashboard...</p>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateNav();
            const user = getUser();
            if (!user || (user.role !== 'admin' && user.role !== 'manager')) {
                window.location.href = 'login.html';
                return;
            }
            loadDashboard();
        });

        async function loadDashboard() {
            const content = document.getElementById('dashboard-content');
            content.innerHTML = `
                <div class="grid">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 1.5rem;">Manage Vehicles</h3>
                        <form id="add-vehicle-form" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-muted);">Add New Vehicle</h4>
                            <div class="form-group"><input type="text" id="v-make" class="form-control" placeholder="Make (e.g. Toyota)" required></div>
                            <div class="form-group"><input type="text" id="v-model" class="form-control" placeholder="Model (e.g. Camry)" required></div>
                            <div class="form-group"><input type="text" id="v-plate" class="form-control" placeholder="License Plate" required></div>
                            <div class="form-group"><input type="text" id="v-type" class="form-control" placeholder="Type (e.g. Sedan)" required></div>
                            <div class="form-group"><input type="number" id="v-capacity" class="form-control" placeholder="Capacity" required></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Add Vehicle</button>
                        </form>
                        <div id="vehicle-list" style="overflow-x: auto;"></div>
                    </div>

                    <div class="glass-card">
                        <h3 style="margin-bottom: 1.5rem;">Manage Drivers</h3>
                        <form id="add-driver-form" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-muted);">Add New Driver</h4>
                            <div class="form-group"><input type="text" id="d-name" class="form-control" placeholder="Full Name" required></div>
                            <div class="form-group"><input type="text" id="d-license" class="form-control" placeholder="License Number" required></div>
                            <div class="form-group"><input type="text" id="d-phone" class="form-control" placeholder="Phone Number" required></div>
                            <div class="form-group">
                                <select id="d-vehicle" class="form-control">
                                    <option value="">Select Vehicle (Optional)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Add Driver</button>
                        </form>
                        <div id="driver-list" style="overflow-x: auto;"></div>
                    </div>
                </div>
            `;

            loadVehicles();
            loadDrivers();
            // ... (rest of listeners stay the same)

            document.getElementById('add-vehicle-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const make = document.getElementById('v-make').value;
                const model = document.getElementById('v-model').value;
                const license_plate = document.getElementById('v-plate').value;
                const type = document.getElementById('v-type').value;
                const capacity = document.getElementById('v-capacity').value;

                try {
                    await apiFetch('taxis.php', 'POST', { make, model, license_plate, type, capacity });
                    loadVehicles();
                    e.target.reset();
                } catch (err) { alert(err.message); }
            });

            document.getElementById('add-driver-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('d-name').value;
                const license_number = document.getElementById('d-license').value;
                const phone = document.getElementById('d-phone').value;
                const vehicle_id = document.getElementById('d-vehicle').value;

                try {
                    await apiFetch('drivers.php', 'POST', { name, license_number, phone, vehicle_id: vehicle_id || null });
                    loadDrivers();
                    e.target.reset();
                } catch (err) { alert(err.message); }
            });
        }

        async function loadVehicles() {
            try {
                const vehicles = await apiFetch('taxis.php');
                const list = document.getElementById('vehicle-list');
                const select = document.getElementById('d-vehicle');

                // Update select dropdown
                let options = '<option value="">Select Vehicle (Optional)</option>';
                vehicles.forEach(v => {
                    options += `<option value="${v.id}">${v.make} ${v.model} (${v.license_plate})</option>`;
                });
                if (select) select.innerHTML = options;

                // Update list
                let html = `<div class="grid" style="margin-top: 2rem;">`;
                vehicles.forEach(v => {
                    html += `
                        <div class="glass-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h3 style="margin-bottom: 0;">${v.make} ${v.model}</h3>
                                <span style="padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem; background: ${v.status === 'active' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; color: ${v.status === 'active' ? '#10b981' : '#f59e0b'}; font-weight: 600;">${v.status.toUpperCase()}</span>
                            </div>
                            <p class="text-muted">ðŸš• ${v.type} â€¢ ðŸ”¢ ${v.license_plate}</p>
                            <p class="text-muted" style="margin-top: 0.5rem;">ðŸ‘¥ Capacity: ${v.capacity} Seats</p>
                            <div style="margin-top: 1.5rem;">
                                <button class="btn btn-glass" style="width: 100%; color: #ef4444;" onclick="deleteVehicle(${v.id})">Delete Vehicle</button>
                            </div>
                        </div>`;
                });
                html += `</div>`;
                list.innerHTML = html;
            } catch (err) { console.error(err); }
        }

        async function loadDrivers() {
            try {
                const drivers = await apiFetch('drivers.php');
                const list = document.getElementById('driver-list');
                let html = `<div class="grid" style="margin-top: 2rem;">`;
                drivers.forEach(d => {
                    const statusColor = d.status === 'active' ? '#10b981' : '#ef4444';
                    const statusBg = d.status === 'active' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    html += `
                        <div class="glass-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h3 style="margin-bottom: 0;">${d.name}</h3>
                                <span style="padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem; background: ${statusBg}; color: ${statusColor}; font-weight: 600;">${d.status.toUpperCase()}</span>
                            </div>
                            <p class="text-muted">ðŸ“ž ${d.phone}</p>
                            <p class="text-muted" style="margin-top: 0.5rem;">ðŸš— ${d.make ? d.make + ' ' + d.model : 'No Vehicle assigned'}</p>
                            <div style="margin-top: 1.5rem;">
                                <button class="btn btn-glass" style="width: 100%; color: #ef4444;" onclick="deleteDriver(${d.id})">Delete Driver</button>
                            </div>
                        </div>`;
                });
                html += `</div>`;
                list.innerHTML = html;
            } catch (err) { console.error(err); }
        }

        async function deleteVehicle(id) {
            if (confirm('Delete this vehicle?')) {
                try {
                    await apiFetch('taxis.php', 'DELETE', { id });
                    loadVehicles();
                } catch (err) { alert(err.message); }
            }
        }

        async function deleteDriver(id) {
            if (confirm('Delete this driver?')) {
                try {
                    await apiFetch('drivers.php', 'DELETE', { id });
                    loadDrivers();
                } catch (err) { alert(err.message); }
            }
        }
    </script>
</body>

</html>