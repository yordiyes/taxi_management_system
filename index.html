<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global Tourism Hub - Tourist Services</title>
    <link rel="stylesheet" href="css/premium.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header>
      <nav>
        <h1>Global Tourism Hub</h1>
        <ul id="nav-list">
          <li><a href="#" onclick="showSection('home')">Home</a></li>
          <li id="auth-link"><a href="login.html">Login</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <!-- Hero Section -->
      <div id="home" class="section">
        <div
          class="card text-center"
          style="
            padding: 4rem 2rem;
            background: linear-gradient(to right, #6366f1, #ec4899);
            color: white;
          "
        >
          <h2 style="color: white; font-size: 2.5rem">
            Discover Your Next Adventure
          </h2>
          <p style="color: rgba(255, 255, 255, 0.9); font-size: 1.2rem">
            One platform for all your travel needs.
          </p>
          <div style="margin-top: 2rem">
            <button
              onclick="showSection('services')"
              class="btn"
              style="background: white; color: #4f46e5; padding: 0.75rem 2rem"
            >
              Start Exploring
            </button>
          </div>
        </div>
      </div>

      <!-- Services Section -->
      <div id="services" class="section hidden">
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('browse')">
            Browse Places
          </button>
          <button class="tab-btn" onclick="switchTab('tickets')">
            Travel Tickets
          </button>
          <button class="tab-btn" onclick="switchTab('hotel')">Hotels</button>
          <button class="tab-btn" onclick="switchTab('restaurant')">
            Restaurants
          </button>
          <button class="tab-btn" onclick="switchTab('taxi')">Taxis</button>
        </div>

        <!-- Browse Places -->
        <div id="tab-browse" class="tab-content">
          <h3>Browse Popular Destinations</h3>
          <div id="places-list" class="grid">
            <p>Loading places...</p>
          </div>
        </div>

        <!-- Tours (formerly Travel Tickets) -->
        <div id="tab-tickets" class="tab-content hidden">
          <div class="card">
            <h3>Find and Book Tours</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem">
              Powered by Tour Management Group
            </p>

            <div style="margin-bottom: 20px; display: flex; gap: 10px">
              <input
                type="text"
                id="tour-search"
                placeholder="Search tours..."
                style="
                  flex: 1;
                  padding: 10px;
                  border: 1px solid #ccc;
                  border-radius: 4px;
                "
              />
              <button onclick="loadTours()" class="btn btn-primary">
                Search
              </button>
            </div>

            <div id="tours-list" class="grid">
              <p>Loading tours...</p>
            </div>
          </div>
        </div>

        <!-- Hotels (Mock - Hotel Management) -->
        <div id="tab-hotel" class="tab-content hidden">
          <div class="card">
            <h3>Reserve Hotel Rooms</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem">
              Connects to Hotel Management Group Service (Group 2, 4)
            </p>

            <!-- Dynamic List Container -->
            <div id="hotel-list" class="grid">
              <p>Click "Hotels" to load data...</p>
            </div>
          </div>
        </div>

        <!-- Restaurants (Mock - Restaurant Management) -->
        <div id="tab-restaurant" class="tab-content hidden">
          <div class="card">
            <h3>Book Restaurant Tables</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem">
              Connects to Restaurant Management Group Service (Group 3, 7)
            </p>
            <div class="grid">
              <div
                class="card"
                style="border: 1px solid #e5e7eb; box-shadow: none"
              >
                <h4>The Gourmet Kitchen</h4>
                <p>üçΩÔ∏è Fine Dining Experience</p>
                <p>Cuisine: French</p>
                <button
                  class="btn btn-secondary"
                  onclick="alert('Booking request sent to Restaurant Management Group!')"
                >
                  Book Table
                </button>
              </div>
              <div
                class="card"
                style="border: 1px solid #e5e7eb; box-shadow: none"
              >
                <h4>Sushi Paradise</h4>
                <p>üç£ Authentic Japanese Cuisine</p>
                <p>Cuisine: Japanese</p>
                <button
                  class="btn btn-secondary"
                  onclick="alert('Booking request sent to Restaurant Management Group!')"
                >
                  Book Table
                </button>
              </div>
              <div
                class="card"
                style="border: 1px solid #e5e7eb; box-shadow: none"
              >
                <h4>Mama's Trattoria</h4>
                <p>üçù Traditional Italian Food</p>
                <p>Cuisine: Italian</p>
                <button
                  class="btn btn-secondary"
                  onclick="alert('Booking request sent to Restaurant Management Group!')"
                >
                  Book Table
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Taxis (Real Implementation - Taxi Service Management) -->
        <div id="tab-taxi" class="tab-content hidden">
          <div class="card">
            <h3>Order a Taxi</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem">
              Real Taxi Service Management (Group 4, 8)
            </p>
            <form id="taxi-booking-form">
              <input type="hidden" id="service-id-input" />

              <div
                id="selected-service-display"
                style="
                  display: none;
                  background: #e0e7ff;
                  color: #4338ca;
                  padding: 1rem;
                  border-radius: var(--radius);
                  margin-bottom: 1rem;
                  border: 1px solid #c7d2fe;
                "
              >
                <!-- Filled by JS -->
              </div>

              <div class="grid">
                <div class="form-group">
                  <label>Pickup Location</label>
                  <input
                    type="text"
                    id="pickup"
                    required
                    placeholder="e.g. Airport Terminal 1"
                  />
                </div>
                <div class="form-group">
                  <label>Dropoff Location</label>
                  <input
                    type="text"
                    id="dropoff"
                    required
                    placeholder="e.g. Grand Hotel Downtown"
                  />
                </div>
                <div class="form-group">
                  <label>Pickup Date & Time</label>
                  <input type="datetime-local" id="time" required />
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-primary"
                style="margin-top: 1rem"
              >
                Book Taxi Ride
              </button>
            </form>
          </div>

          <h3>Available Taxi Services</h3>
          <div id="taxi-list" class="grid">
            <!-- Loaded via JS -->
          </div>
        </div>
      </div>
    </div>

    <script src="js/app.js"></script>
    <script>
      // Tab switching logic
      async function switchTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById("tab-" + tabName).classList.remove("hidden");

        document
          .querySelectorAll(".tab-btn")
          .forEach((el) => el.classList.remove("active"));
        const btn = document.querySelector(
          `button[onclick="switchTab('${tabName}')"]`
        );
        if (btn) btn.classList.add("active");

        if (tabName === "taxi") loadTaxis();
        else if (tabName === "hotel") loadHotels(); // FETCH FROM GROUP 2
        else if (tabName === "browse") loadPlaces();
        else if (tabName === "tickets") loadTours();
      }

      // --- TOUR MANAGEMENT INTEGRATION ---
      const TOUR_API_BASE = "https://tour-management-web.onrender.com/api/v1/";
      const TOUR_API_KEY = "demo-api-key";

      async function fetchTourApi(
        endpoint,
        method = "GET",
        body = null,
        queryParams = {}
      ) {
        let url = new URL(TOUR_API_BASE + endpoint);
        Object.keys(queryParams).forEach((key) => {
          if (queryParams[key]) url.searchParams.append(key, queryParams[key]);
        });

        const options = {
          method: method,
          headers: {
            "Content-Type": "application/json",
            "X-API-KEY": TOUR_API_KEY,
          },
        };
        if (body) options.body = JSON.stringify(body);

        const res = await fetch(url, options);
        return await res.json();
      }

      async function loadPlaces() {
        const list = document.getElementById("places-list");
        list.innerHTML = "<p>Loading places...</p>";
        try {
          const res = await fetchTourApi("places.php");
          if (!res.data || res.data.length === 0) {
            list.innerHTML = "<p>No places found.</p>";
            return;
          }
          list.innerHTML = res.data
            .map(
              (p) => `
                  <div class="card">
                      <img src="https://via.placeholder.com/400x200/6366f1/ffffff?text=${encodeURIComponent(
                        p.name
                      )}" style="width: 100%; border-radius: var(--radius); margin-bottom: 1rem;">
                      <h4>${p.name}</h4>
                      <p>${p.type || "Destination"}</p>
                      <button class="btn btn-primary" onclick="alert('View details for ${
                        p.name
                      }')">View Details</button>
                  </div>
              `
            )
            .join("");
        } catch (e) {
          console.error(e);
          list.innerHTML = '<p style="color:red">Error loading places.</p>';
        }
      }

      async function loadTours() {
        const list = document.getElementById("tours-list");
        const q = document.getElementById("tour-search").value;
        list.innerHTML = "<p>Loading tours...</p>";
        try {
          const res = await fetchTourApi("tours.php", "GET", null, { q });
          if (!res.data || res.data.length === 0) {
            list.innerHTML = "<p>No tours found.</p>";
            return;
          }
          list.innerHTML = res.data
            .map(
              (t) => `
                  <div class="card">
                      <h4>${t.title}</h4>
                      <p><strong>Location:</strong> ${t.location}</p>
                      <p><strong>Price:</strong> $${t.price}</p>
                      <p><strong>Date:</strong> ${t.schedule_date}</p>
                      <button class="btn btn-primary" onclick="bookTourPrompt(${t.id}, '${t.title}')">Book Now</button>
                  </div>
              `
            )
            .join("");
        } catch (e) {
          console.error(e);
          list.innerHTML = '<p style="color:red">Error loading tours.</p>';
        }
      }

      async function bookTourPrompt(tourId, tourTitle) {
        const email = prompt(
          `Enter your email to book "${tourTitle}":`,
          "guest@example.com"
        );
        if (!email) return;

        try {
          const res = await fetchTourApi("tours.php", "POST", {
            tour_id: tourId,
            email: email,
            name: "Guest User",
          });
          alert("Booking Response: " + JSON.stringify(res));
        } catch (e) {
          alert("Booking failed: " + e.message);
        }
      }

      function showSection(sectionId) {
        document
          .querySelectorAll(".section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(sectionId).classList.remove("hidden");
      }

      // --- EXTERNAL INTEGRATION EXAMPLE (HOTELS) ---
      async function loadHotels() {
        const list = document.getElementById("hotel-list");
        list.innerHTML = "<p>Loading hotels from Group 2...</p>";

        try {
          // TODO: Replace this URL with the actual API from Group 2
          // const res = await fetch('http://localhost/hotel_management/api/rooms.php');
          // const hotels = await res.json();

          // MOCK DATA (Simulating what their API would return)
          const hotels = [
            { name: "Grand Luxury Hotel (From API)", rating: 5, price: 250 },
            { name: "Cozy Inn (From API)", rating: 3, price: 80 },
            { name: "Business Suites (From API)", rating: 4, price: 150 },
          ];

          // Simulate network delay
          await new Promise((r) => setTimeout(r, 500));

          if (hotels.length === 0) {
            list.innerHTML = "<p>No hotels found.</p>";
            return;
          }

          list.innerHTML = hotels
            .map(
              (h) => `
                  <div class="card" style="border: 1px solid #e5e7eb; box-shadow: none;">
                      <h4>${h.name}</h4>
                      <p>${"‚≠ê".repeat(h.rating)}</p>
                      <p>$${h.price}/night</p>
                      <button class="btn btn-secondary" onclick="alert('This would send a request to the Hotel Group API or redirect to their booking page')">Reserve Now</button>
                  </div>
              `
            )
            .join("");
        } catch (e) {
          console.error(e);
          list.innerHTML =
            '<p style="color:red">Error loading hotels from external service.</p>';
        }
      }

      // Load Taxis
      async function loadTaxis() {
        try {
          const services = await apiFetch("services.php");
          const list = document.getElementById("taxi-list");
          if (services.length === 0) {
            list.innerHTML = "<p>No taxi services available at the moment.</p>";
            return;
          }
          list.innerHTML = services
            .map(
              (s) => `
                    <div class="card">
                        <h4>${s.name}</h4>
                        <p>${s.description}</p>
                        <p><strong>Base Price:</strong> $${s.base_price}</p>
                        <p><strong>Per KM:</strong> $${s.price_per_km}</p>
                        <button class="btn btn-primary" onclick="prefillTaxi('${s.id}', '${s.name}')">Select This Taxi</button>
                    </div>
                `
            )
            .join("");
        } catch (e) {
          console.error(e);
          document.getElementById("taxi-list").innerHTML =
            "<p>Error loading taxi services.</p>";
        }
      }

      function prefillTaxi(id, name) {
        // Set hidden input
        document.getElementById("service-id-input").value = id;

        // Update visual indicator
        const display = document.getElementById("selected-service-display");
        display.style.display = "block";
        display.innerHTML = `<strong>Selected Service:</strong> ${name} <button onclick="clearSelection()" style="float:right; background:none; border:none; color:currentColor; cursor:pointer;">&times; Change</button>`;

        // Scroll to form
        document
          .getElementById("taxi-booking-form")
          .scrollIntoView({ behavior: "smooth" });

        // Focus first field
        document.getElementById("pickup").focus();
      }

      function clearSelection() {
        document.getElementById("service-id-input").value = "";
        document.getElementById("selected-service-display").style.display =
          "none";
      }

      // Taxi Booking
      document
        .getElementById("taxi-booking-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const user = getUser();
          if (!user) {
            alert("Please login to book a taxi.");
            window.location.href = "login.html";
            return;
          }

          const data = {
            user_id: user.id,
            service_id: document.getElementById("service-id-input").value,
            pickup_location: document.getElementById("pickup").value,
            dropoff_location: document.getElementById("dropoff").value,
            pickup_time: document.getElementById("time").value,
          };

          if (!data.service_id) {
            alert("Please select a taxi service from the list below.");
            return;
          }

          try {
            await apiFetch("bookings.php", "POST", data);
            alert(
              "Taxi booked successfully! You will receive confirmation shortly."
            );
            e.target.reset();
            clearSelection();
          } catch (err) {
            alert("Booking failed: " + err.message);
          }
        });

      // Check Auth and update nav
      const user = getUser();
      if (user) {
        let navHtml =
          '<li><a href="#" onclick="showSection(\'home\')">Home</a></li>';
        if (user.role === "admin" || user.role === "manager") {
          navHtml +=
            '<li><a href="provider_dashboard.html">Provider Dashboard</a></li>';
        }
        navHtml += `<li><a href="#" onclick="logout()">Logout (${user.username})</a></li>`;
        document.getElementById("nav-list").innerHTML = navHtml;
      }
    </script>
  </body>
</html>
