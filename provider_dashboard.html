<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Dashboard - Taxi Service</title>
    <link rel="stylesheet" href="css/modern.css">
</head>

<body>
    <header>
        <nav>
            <a href="index.html" class="logo">Provider Hub</a>
            <ul class="nav-links" id="nav-list">
                <li><a href="#" class="active" onclick="showSection('stats')">Overview</a></li>
                <li><a href="#" onclick="showSection('services')">Services</a></li>
                <li><a href="#" onclick="showSection('vehicles')">Vehicles</a></li>
                <li><a href="#" onclick="showSection('drivers')">Drivers</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <!-- Stats Section -->
        <section id="stats" class="section">
            <h1 style="margin: 2rem 0;">Business Overview</h1>
            <div class="grid">
                <div class="glass-card text-center">
                    <div class="stat-value" id="total-users" style="font-size: 3rem; margin-bottom: 0.5rem;">-</div>
                    <div class="stat-label" style="letter-spacing: 0.1em; font-weight: 600;">Total Users</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-value" id="total-bookings" style="font-size: 3rem; margin-bottom: 0.5rem;">-</div>
                    <div class="stat-label" style="letter-spacing: 0.1em; font-weight: 600;">Total Bookings</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-value" id="total-services" style="font-size: 3rem; margin-bottom: 0.5rem;">-</div>
                    <div class="stat-label" style="letter-spacing: 0.1em; font-weight: 600;">Active Services</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-value" id="visitors-today" style="font-size: 3rem; margin-bottom: 0.5rem;">-</div>
                    <div class="stat-label" style="letter-spacing: 0.1em; font-weight: 600;">Visitors Today</div>
                </div>
            </div>

            <h2 class="mt-8" style="margin-bottom: 1.5rem;">Recent Bookings</h2>
            <div class="glass-card" style="padding: 1.5rem; overflow-x: auto;">
                <div id="booking-history">
                    <p class="text-muted">Loading transactions...</p>
                </div>
            </div>
        </section>

        <!-- Services Management -->
        <section id="services" class="section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
                <h1>Manage Services</h1>
                <button class="btn btn-primary" onclick="openServiceModal()">+ Add New Service</button>
            </div>
            <div id="services-list" class="grid"></div>
        </section>

        <!-- Vehicle Management -->
        <section id="vehicles" class="section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
                <h1>Manage Vehicles</h1>
                <button class="btn btn-primary" onclick="openVehicleModal()">+ Add New Vehicle</button>
            </div>
            <div id="vehicles-list" class="grid"></div>
        </section>

        <!-- Driver Management -->
        <section id="drivers" class="section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0;">
                <h1>Manage Drivers</h1>
                <button class="btn btn-primary" onclick="openDriverModal()">+ Add New Driver</button>
            </div>
            <div id="drivers-list" class="grid"></div>
        </section>
    </main>

    <!-- Add Service Modal -->
    <div id="service-modal" class="glass-card"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 480px; display: none; z-index: 1001; box-shadow: 0 0 40px rgba(0,0,0,0.5);">
        <h3>Add/Edit Service</h3>
        <form id="service-form" class="mt-8">
            <input type="hidden" id="service-id">
            <div class="form-group">
                <label>Service Name</label>
                <input type="text" id="service-name" class="form-control" required placeholder="Luxury Sedan Service">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="service-desc" class="form-control" rows="3" placeholder="Premium door-to-door service..."></textarea>
            </div>
            <div class="grid" style="margin-top: 0;">
                <div class="form-group">
                    <label>Base Price ($)</label>
                    <input type="number" id="service-base" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Price per KM ($)</label>
                    <input type="number" id="service-km" class="form-control" step="0.01" required>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-glass" onclick="closeServiceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="vehicle-modal" class="glass-card"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 480px; display: none; z-index: 1001; box-shadow: 0 0 40px rgba(0,0,0,0.5);">
        <h3>Add/Edit Vehicle</h3>
        <form id="vehicle-form" class="mt-8">
            <input type="hidden" id="vehicle-id">
            <div class="grid" style="margin: 0;">
                <div class="form-group">
                    <label>Make</label>
                    <input type="text" id="vehicle-make" class="form-control" required placeholder="Tesla">
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="vehicle-model" class="form-control" required placeholder="Model S">
                </div>
            </div>
            <div class="form-group">
                <label>License Plate</label>
                <input type="text" id="vehicle-license" class="form-control" required placeholder="ABC-1234">
            </div>
            <div class="grid" style="margin: 0;">
                <div class="form-group">
                    <label>Type</label>
                    <select id="vehicle-type" class="form-control">
                        <option value="Sedan">Sedan</option>
                        <option value="SUV">SUV</option>
                        <option value="Van">Van</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Capacity</label>
                    <input type="number" id="vehicle-capacity" class="form-control" required>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-glass" onclick="closeVehicleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Vehicle</button>
            </div>
        </form>
    </div>

    <!-- Add Driver Modal -->
    <div id="driver-modal" class="glass-card"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 440px; display: none; z-index: 1001; box-shadow: 0 0 40px rgba(0,0,0,0.5);">
        <h3>Add/Edit Driver</h3>
        <form id="driver-form" class="mt-8">
            <input type="hidden" id="driver-id">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="driver-name" class="form-control" required placeholder="Jane Smith">
            </div>
            <div class="form-group">
                <label>License Number</label>
                <input type="text" id="driver-license" class="form-control" required placeholder="DL-98765432">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" id="driver-phone" class="form-control" required placeholder="+1 (555) 000-0000">
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-glass" onclick="closeDriverModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Driver</button>
            </div>
        </form>
    </div>

    <!-- Backdrop -->
    <div id="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; z-index: 1000;"></div>

    <script src="js/app.js"></script>
    <script>
        // Auth Check
        const user = getUser();
        if (!user || (user.role !== 'admin' && user.role !== 'manager')) {
            alert('Access Denied. Admins/Managers only.');
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadServices();
            loadVehicles();
            loadDrivers();
        });

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function loadStats() {
            try {
                const stats = await apiFetch('stats.php?action=stats');
                document.getElementById('total-users').textContent = stats.total_users;
                document.getElementById('total-bookings').textContent = stats.total_bookings;
                document.getElementById('total-services').textContent = stats.total_services;
                document.getElementById('visitors-today').textContent = stats.visitors_today;

                const history = await apiFetch('stats.php?action=history');
                const historyContainer = document.getElementById('booking-history');
                if (history.length === 0) {
                    historyContainer.innerHTML = '<p class="text-muted">No recent bookings found.</p>';
                    return;
                }

                let html = `<div class="grid" style="margin-top: 1.5rem;">`;
                history.forEach(h => {
                    let actionBtn = '';
                    if (h.status === 'pending') {
                        actionBtn = `<button class="btn btn-primary" onclick="updateBookingStatus(${h.id}, 'confirmed')" style="width: 100%;">Approve</button>`;
                    } else if (h.status === 'confirmed') {
                        actionBtn = `<button class="btn btn-primary" onclick="updateBookingStatus(${h.id}, 'completed')" style="width: 100%; background: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">Complete</button>`;
                    } else {
                        actionBtn = '<button class="btn btn-glass" style="width: 100%; cursor: default;" disabled>Completed</button>';
                    }

                    const statusColor = h.status === 'pending' ? '#f59e0b' : (h.status === 'confirmed' ? '#6366f1' : '#10b981');
                    const statusBg = h.status === 'pending' ? 'rgba(245, 158, 11, 0.1)' : (h.status === 'confirmed' ? 'rgba(99, 102, 241, 0.1)' : 'rgba(16, 185, 129, 0.1)');

                    html += `
                        <div class="glass-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h3 style="margin-bottom: 0;">${h.username || 'Guest'}</h3>
                                <span style="padding: 0.2rem 0.6rem; border-radius: 20px; background: ${statusBg}; color: ${statusColor}; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${h.status}</span>
                            </div>
                            <p class="text-muted">üöñ ${h.service_name || 'Taxi Service'}</p>
                            <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.4rem;">üìç From: ${h.pickup_location}</p>
                            <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.2rem;">üìÖ ${new Date(h.created_at).toLocaleDateString()}</p>
                            <div style="margin-top: 1.5rem;">
                                ${actionBtn}
                            </div>
                        </div>`;
                });
                html += '</div>';
                historyContainer.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function updateBookingStatus(id, status) {
            if(!confirm(`Mark booking as ${status}?`)) return;
            try {
                await apiFetch(`bookings.php?id=${id}`, 'PUT', { status });
                loadStats();
            } catch(e) { alert(e.message); }
        }

        // --- Services ---
        async function loadServices() {
            try {
                const services = await apiFetch('services.php');
                const list = document.getElementById('services-list');
                list.innerHTML = services.map(s => `
                    <div class="glass-card">
                        <h3 style="margin-bottom: 0.5rem;">${s.name}</h3>
                        <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">${s.description}</p>
                        <p style="margin-top: 1rem; font-weight: 600;">üí∞ $${s.base_price} Base ‚Ä¢ $${s.price_per_km}/km</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                            <button class="btn btn-glass" style="flex: 1;" onclick='editService(${JSON.stringify(s)})'>Edit</button>
                            <button class="btn btn-glass" style="color: #ef4444;" onclick="deleteService(${s.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        const bd = document.getElementById('modal-backdrop');
        function openServiceModal(service = null) {
            document.getElementById('service-modal').style.display = 'block';
            bd.style.display = 'block';
            if (service) {
                document.getElementById('service-id').value = service.id;
                document.getElementById('service-name').value = service.name;
                document.getElementById('service-desc').value = service.description;
                document.getElementById('service-base').value = service.base_price;
                document.getElementById('service-km').value = service.price_per_km;
            } else {
                document.getElementById('service-form').reset();
                document.getElementById('service-id').value = '';
            }
        }
        function closeServiceModal() { 
            document.getElementById('service-modal').style.display = 'none';
            bd.style.display = 'none';
        }
        function editService(s) { openServiceModal(s); }

        document.getElementById('service-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('service-id').value;
            const data = {
                name: document.getElementById('service-name').value,
                description: document.getElementById('service-desc').value,
                base_price: document.getElementById('service-base').value,
                price_per_km: document.getElementById('service-km').value
            };
            try {
                if (id) await apiFetch(`services.php?id=${id}`, 'PUT', data);
                else await apiFetch('services.php', 'POST', data);
                closeServiceModal();
                loadServices();
                loadStats();
            } catch (err) { alert(err.message); }
        });

        async function deleteService(id) {
            if (!confirm('Are you sure you want to delete this service?')) return;
            try { await apiFetch(`services.php?id=${id}`, 'DELETE'); loadServices(); loadStats(); } catch (err) { alert(err.message); }
        }

        // --- Vehicles ---
        async function loadVehicles() {
            try {
                const vehicles = await apiFetch('vehicles.php');
                const list = document.getElementById('vehicles-list');
                list.innerHTML = vehicles.map(v => `
                    <div class="glass-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="margin-bottom: 0;">${v.make} ${v.model}</h3>
                            <span style="padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600;">${v.status.toUpperCase()}</span>
                        </div>
                        <p class="text-muted">üöï ${v.type} ‚Ä¢ üî¢ ${v.license_plate}</p>
                        <p class="text-muted" style="margin-top: 0.5rem;">üë• Capacity: ${v.capacity} Seats</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                            <button class="btn btn-glass" style="flex: 1;" onclick='editVehicle(${JSON.stringify(v)})'>Edit</button>
                            <button class="btn btn-glass" style="color: #ef4444;" onclick="deleteVehicle(${v.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function openVehicleModal(vehicle = null) {
            document.getElementById('vehicle-modal').style.display = 'block';
            bd.style.display = 'block';
            if (vehicle) {
                document.getElementById('vehicle-id').value = vehicle.id;
                document.getElementById('vehicle-make').value = vehicle.make;
                document.getElementById('vehicle-model').value = vehicle.model;
                document.getElementById('vehicle-license').value = vehicle.license_plate;
                document.getElementById('vehicle-type').value = vehicle.type;
                document.getElementById('vehicle-capacity').value = vehicle.capacity;
            } else {
                document.getElementById('vehicle-form').reset();
                document.getElementById('vehicle-id').value = '';
            }
        }
        function closeVehicleModal() { 
            document.getElementById('vehicle-modal').style.display = 'none';
            bd.style.display = 'none';
        }
        function editVehicle(v) { openVehicleModal(v); }

        document.getElementById('vehicle-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('vehicle-id').value;
            const data = {
                make: document.getElementById('vehicle-make').value,
                model: document.getElementById('vehicle-model').value,
                license_plate: document.getElementById('vehicle-license').value,
                type: document.getElementById('vehicle-type').value,
                capacity: document.getElementById('vehicle-capacity').value
            };
            try {
                if (id) await apiFetch(`vehicles.php?id=${id}`, 'PUT', data);
                else await apiFetch('vehicles.php', 'POST', data);
                closeVehicleModal();
                loadVehicles();
            } catch (err) { alert(err.message); }
        });

        async function deleteVehicle(id) {
            if (!confirm('Delete this vehicle permanently?')) return;
            try { await apiFetch(`vehicles.php?id=${id}`, 'DELETE'); loadVehicles(); } catch (err) { alert(err.message); }
        }

        // --- Drivers ---
        async function loadDrivers() {
            try {
                const drivers = await apiFetch('drivers.php');
                const list = document.getElementById('drivers-list');
                list.innerHTML = drivers.map(d => `
                    <div class="glass-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="margin-bottom: 0;">${d.name}</h3>
                            <span style="padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600;">ACTIVE</span>
                        </div>
                        <p class="text-muted">üìû ${d.phone}</p>
                        <p class="text-muted" style="margin-top: 0.5rem;">üÜî License: ${d.license_number}</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                            <button class="btn btn-glass" style="flex: 1;" onclick='editDriver(${JSON.stringify(d)})'>Edit</button>
                            <button class="btn btn-glass" style="color: #ef4444;" onclick="deleteDriver(${d.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function openDriverModal(driver = null) {
            document.getElementById('driver-modal').style.display = 'block';
            bd.style.display = 'block';
            if (driver) {
                document.getElementById('driver-id').value = driver.id;
                document.getElementById('driver-name').value = driver.name;
                document.getElementById('driver-license').value = driver.license_number;
                document.getElementById('driver-phone').value = driver.phone;
            } else {
                document.getElementById('driver-form').reset();
                document.getElementById('driver-id').value = '';
            }
        }
        function closeDriverModal() { 
            document.getElementById('driver-modal').style.display = 'none';
            bd.style.display = 'none';
        }
        function editDriver(d) { openDriverModal(d); }

        document.getElementById('driver-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('driver-id').value;
            const data = {
                name: document.getElementById('driver-name').value,
                license_number: document.getElementById('driver-license').value,
                phone: document.getElementById('driver-phone').value
            };
            try {
                if (id) await apiFetch(`drivers.php?id=${id}`, 'PUT', data);
                else await apiFetch('drivers.php', 'POST', data);
                closeDriverModal();
                loadDrivers();
            } catch (err) { alert(err.message); }
        });

        async function deleteDriver(id) {
            if (!confirm('Delete driver record?')) return;
            try { await apiFetch(`drivers.php?id=${id}`, 'DELETE'); loadDrivers(); } catch (err) { alert(err.message); }
        }
    </script>
</body>

</html>