<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Sandbox | Partner Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/modern.css">
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        margin-top: 1.5rem;
      }
      .output-area {
        background: #000;
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        margin-top: 2rem;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }
      hr {
        border: 0;
        border-top: 1px solid var(--glass-border);
        margin: 2rem 0;
      }
      h4 { margin-top: 2rem; color: var(--primary); }
    </style>
  </head>
  <body>
    <div class="sandbox-container">
        <h1 class="gradient-text" style="font-size: 3rem; margin-bottom: 1rem;">API Sandbox</h1>
        <p class="text-muted" style="margin-bottom: 3rem;">Universal partner integration tester for Taxi & Tour services.</p>

    <div class="glass-card">
      <h3 style="margin-top: 0;">1. Configuration</h3>
      <div class="label">API BASE URL</div>
      <input
        type="text"
        id="baseUrl"
        class="form-control"
        value="https://taxi-system.infinityfreeapp.com/api"
      />
      <div class="label">API KEY</div>
      <input type="text" id="apiKey" class="form-control" value="TAXI_GROUP_SECURE_KEY_2024" />
    </div>

    <div class="glass-card mt-8">
      <h3 style="margin-top: 0;">2. Get All Services (Public)</h3>
      <button class="btn btn-primary" style="width: 100%;" onclick="test('/services.php', 'GET')">Fetch Services</button>
    </div>

    <div class="glass-card mt-8">
      <h3 style="margin-top: 0;">3. Seamless Booking (Partner Integration)</h3>
      <div class="label">USER EMAIL</div>
      <input type="email" id="bookEmail" class="form-control" value="tester@gmail.com" />
      <div class="label">PICKUP LOCATION</div>
      <input type="text" id="pickup" class="form-control" value="Central Mall" />
      <div class="label">DROPOFF LOCATION</div>
      <input type="text" id="dropoff" class="form-control" value="Airport" />
      <div class="label">PICKUP TIME (YYYY-MM-DD HH:MM:SS)</div>
      <input type="text" id="time" class="form-control" value="2025-01-01 12:00:00" />
      <button class="btn btn-primary mt-8" style="width: 100%;" onclick="bookTaxi()">Order Taxi Seamlessly</button>
    </div>

    <div class="glass-card mt-8">
      <h3 style="margin-top: 0;">4. View Bookings by Email</h3>
      <div class="label">USER EMAIL</div>
      <input type="email" id="viewEmail" class="form-control" value="tester@gmail.com" />
      <button class="btn btn-primary mt-8" style="width: 100%;" onclick="viewBookings()">Fetch History</button>
    </div>

    <div class="glass-card mt-8" style="border: 1px solid var(--primary); background: rgba(99, 102, 241, 0.05)">
      <h3 style="color: var(--primary); margin-top: 0;">
        5. Tour Management Integration (External API)
      </h3>

      <div class="label">TOUR API BASE URL</div>
      <input
        type="text"
        id="tourBaseUrl"
        class="form-control"
        value="https://tour-management-web.onrender.com/api/v1/"
      />
      <div class="label">TOUR API KEY</div>
      <input type="text" id="tourApiKey" class="form-control" value="demo-api-key" />

      <hr>

      <h4>Explore Places</h4>
      <div class="label">Search Query (optional)</div>
      <input type="text" id="placeQuery" class="form-control" placeholder="e.g. Paris" />
      <button class="btn btn-glass mt-4" style="width: 100%; color: #10b981;" onclick="getPlaces()">
        Fetch Places
      </button>

      <h4>Find Tours</h4>
      <div class="label">Search Query (optional)</div>
      <input type="text" id="tourQuery" class="form-control" placeholder="e.g. Walking Tour" />
      <button class="btn btn-glass mt-4" style="width: 100%; color: #10b981;" onclick="getTours()">
        Fetch Tours
      </button>

      <h4>Book a Tour</h4>
      <div class="label">Tour ID</div>
      <input type="number" id="bookTourId" class="form-control" value="1" />
      <div class="label">User Email</div>
      <input
        type="email"
        id="bookTourEmail"
        class="form-control"
        value="partner-guest@example.com"
      />
      <div class="label">Guest Name</div>
      <input type="text" id="bookTourName" class="form-control" value="Guest from Partner" />
      <button class="btn btn-primary mt-8" style="width: 100%;" onclick="bookTour()">
        Book Tour
      </button>
    </div>

    <div class="output-area">
      <h3 style="margin-top: 0; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.1em;">LIVE RESPONSE OUTPUT</h3>
      <pre
        id="output"
        style="color: #10b981; margin-top: 1rem;"
      >
// Results will appear here...</pre
      >
    </div>

    <script>
      const output = document.getElementById("output");

      async function test(path, method, body = null) {
        output.innerText = "// Sending request...";
        const url = document.getElementById("baseUrl").value + path;
        const key = document.getElementById("apiKey").value;

        try {
          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
              "X-API-KEY": key,
            },
          };
          if (method === "GET" && path.includes(".php")) {
            // Inject key into URL for GET if needed
            const finalUrl = new URL(url);
            finalUrl.searchParams.append("api_key", key);
            var reqUrl = finalUrl.toString();
          } else if (body) {
            options.body = JSON.stringify(body);
            var reqUrl = url;
          } else {
            var reqUrl = url;
          }

          const response = await fetch(reqUrl, options);
          const data = await response.json();
          output.innerText = JSON.stringify(data, null, 2);
        } catch (err) {
          output.innerText =
            "Error: " +
            err.message +
            "\nCheck browser console for details (F12).";
        }
      }

      function bookTaxi() {
        const body = {
          email: document.getElementById("bookEmail").value,
          pickup_location: document.getElementById("pickup").value,
          dropoff_location: document.getElementById("dropoff").value,
          pickup_time: document.getElementById("time").value,
        };
        test("/bookings.php", "POST", body);
      }

      function viewBookings() {
        const email = document.getElementById("viewEmail").value;
        test("/bookings.php?email=" + encodeURIComponent(email), "GET");
      }

      // Tour Management API Functions
      async function callTourApi(
        endpoint,
        method,
        body = null,
        queryParams = {}
      ) {
        output.innerText = "// Sending request to Tour API...";
        const baseUrl = document.getElementById("tourBaseUrl").value;
        const key = document.getElementById("tourApiKey").value;

        // Remove trailing slash from baseUrl if present and leading slash from endpoint if present to avoid double slashes
        const cleanBaseUrl = baseUrl.replace(/\/$/, "");
        const cleanEndpoint = endpoint.replace(/^\//, "");
        let urlObj = new URL(cleanBaseUrl + "/" + cleanEndpoint);

        // Add query params
        Object.keys(queryParams).forEach((k) => {
          if (queryParams[k]) urlObj.searchParams.append(k, queryParams[k]);
        });

        const options = {
          method: method,
          headers: {
            "Content-Type": "application/json",
            "X-API-KEY": key,
          },
        };

        if (body) {
          options.body = JSON.stringify(body);
        }

        try {
          const response = await fetch(urlObj.toString(), options);
          const data = await response.json();
          output.innerText = JSON.stringify(data, null, 2);
        } catch (err) {
          output.innerText =
            "Error: " +
            err.message +
            "\nCheck browser console for details (F12).";
        }
      }

      function getPlaces() {
        const q = document.getElementById("placeQuery").value;
        callTourApi("places.php", "GET", null, { q });
      }

      function getTours() {
        const q = document.getElementById("tourQuery").value;
        callTourApi("tours.php", "GET", null, { q });
      }

      function bookTour() {
        const body = {
          tour_id: document.getElementById("bookTourId").value,
          email: document.getElementById("bookTourEmail").value,
          name: document.getElementById("bookTourName").value,
        };
        callTourApi("tours.php", "POST", body);
      }
    </script>
  </body>
</html>
